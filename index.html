<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    script-src 'self' https://alcdn.msauth.net https://cdn.jsdelivr.net;
    connect-src 'self' https://login.microsoftonline.com https://api.powerbi.com;
    frame-src 'self' https://app.powerbi.com;
    style-src 'self' 'unsafe-inline';
    media-src 'self' https://www.w3schools.com;
  ">
  <title>Power BI & Video Switcher</title>
  <script src="https://alcdn.msauth.net/browser/3.5.0/js/msal-browser.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/powerbi-client@2.23.0/dist/powerbi.min.js"></script>
  <style>
    body { font-family: sans-serif; margin: 0; padding: 0; }
    #container { width: 100%; height: 100vh; display: flex; align-items: center; justify-content: center; }
    #reportContainer, #videoContainer { width: 100%; height: 100%; display: none; }
    iframe, video { width: 100%; height: 100%; border: none; }
  </style>
</head>
<body>
  <div id="container">
    <div id="reportContainer"></div>
    <div id="videoContainer">
      <video id="video" muted autoplay loop>
        <source src="https://www.w3schools.com/html/mov_bbb.mp4" type="video/mp4" />
        Your browser does not support the video tag.
      </video>
    </div>
  </div>

  <script>
    const msalConfig = {
      auth: {
        clientId: "YOUR_CLIENT_ID",
        authority: "https://login.microsoftonline.com/YOUR_TENANT_ID",
        redirectUri: "https://YOUR_USERNAME.github.io/YOUR_REPO/"
      },
      cache: { cacheLocation: "localStorage" }
    };

    const msalInstance = new msal.PublicClientApplication(msalConfig);
    const loginRequest = {
      scopes: ["https://analysis.windows.net/powerbi/api/.default"]
    };

    async function getAccessToken() {
      try {
        const account = msalInstance.getActiveAccount() || (await msalInstance.loginPopup(loginRequest)).account;
        msalInstance.setActiveAccount(account);
        const tokenResponse = await msalInstance.acquireTokenSilent(loginRequest);
        return tokenResponse.accessToken;
      } catch (error) {
        console.warn("Silent token acquisition failed, falling back to popup:", error);
        const tokenResponse = await msalInstance.acquireTokenPopup(loginRequest);
        return tokenResponse.accessToken;
      }
    }

    async function signInAndEmbed() {
      try {
        const embedReport = async () => {
          const accessToken = await getAccessToken();
          const embedConfig = {
            type: 'report',
            id: "YOUR_REPORT_ID",
            embedUrl: "https://app.powerbi.com/reportEmbed?reportId=YOUR_REPORT_ID&groupId=YOUR_WORKSPACE_ID",
            accessToken: accessToken,
            tokenType: powerbi.models.TokenType.Aad,
            settings: {
              filterPaneEnabled: false,
              navContentPaneEnabled: true
            }
          };

          const reportContainer = document.getElementById("reportContainer");
          const report = powerbi.embed(reportContainer, embedConfig);

          report.on("error", async (event) => {
            console.error("Power BI error:", event.detail);
            if (event.detail.message.includes("TokenExpired")) {
              const newToken = await getAccessToken();
              report.setAccessToken(newToken);
            }
          });

          setInterval(async () => {
            const newToken = await getAccessToken();
            report.setAccessToken(newToken);
          }, 55 * 60 * 1000);
        };

        await embedReport();
        startSwitching();
      } catch (err) {
        console.error("Authentication or embedding failed:", err);
      }
    }

    function startSwitching() {
      const reportContainer = document.getElementById("reportContainer");
      const videoContainer = document.getElementById("videoContainer");
      const video = document.getElementById("video");
      let showVideo = false;

      reportContainer.style.display = "block";

      setInterval(async () => {
        showVideo = !showVideo;
        reportContainer.style.display = showVideo ? "none" : "block";
        videoContainer.style.display = showVideo ? "block" : "none";

        if (showVideo) {
          try {
            await video.play();
          } catch (err) {
            console.warn("Video playback failed:", err);
          }
          const report = powerbi.get(reportContainer);
          if (report) report.iframe.contentWindow.postMessage({ action: "pause" }, "*");
        } else {
          const report = powerbi.get(reportContainer);
          if (report) report.iframe.contentWindow.postMessage({ action: "resume" }, "*");
        }
      }, 60000);
    }

    signInAndEmbed();
  </script>
</body>
</html>
